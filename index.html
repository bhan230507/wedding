# -*- coding: utf-8 -*-
"""
GitHub Pages용 정적 사이트 빌드 스크립트.
실행 후 docs/ 폴더를 GitHub 저장소에 푸시하면 Pages가 배포됩니다.
"""
import os
import shutil
import sys

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
STATIC_DIR = os.path.join(BASE_DIR, "static")
IMAGE_DIR = os.path.join(BASE_DIR, "image")
TEMPLATES_DIR = os.path.join(BASE_DIR, "templates")
OUT_DIR = os.path.join(BASE_DIR, "docs")

# 상대 경로 사용 시 CSS/이미지 깨짐 방지 (저장소 루트에 올릴 때 권장)
# "" = 상대 경로, "/wedding/" = 절대 경로 (저장소 이름에 맞게)
GHPAGES_BASE = os.environ.get("GHPAGES_BASE", "")

GALLERY_EXT = (".jpg", ".jpeg", ".png", ".webp")


def get_gallery_images():
    if not os.path.isdir(IMAGE_DIR):
        return []
    names = []
    for name in sorted(os.listdir(IMAGE_DIR)):
        lower = name.lower()
        if any(lower.endswith(ext) for ext in GALLERY_EXT):
            names.append("image/" + name)
    return names


def build():
    try:
        from jinja2 import Environment, FileSystemLoader
    except ImportError:
        print("Jinja2가 필요합니다: pip install jinja2")
        sys.exit(1)

    # base_url: "" = 상대 경로, "/wedding/" 처럼 넣으면 절대 경로
    base_url = GHPAGES_BASE or ""
    if base_url and not base_url.endswith("/"):
        base_url += "/"

    photo_url = "image/main_pic.jpg" if os.path.isfile(os.path.join(IMAGE_DIR, "main_pic.jpg")) else ""

    context = {
        "base_url": base_url,
        "groom_name": "한기정",
        "bride_name": "방지윤",
        "wedding_date": "2026년 4월 18일 (토)",
        "wedding_time": "오후 4시 00분",
        "date_month": "04",
        "date_day": "18",
        "full_date": "2026.04.18.(토)",
        "date_time_display": "2026.04.18 16:00",
        "venue_name": "제주정원",
        "venue_street": "제주 제주시 구좌읍 송당2길 25",
        "venue_lot": "제주 제주시 구좌읍 송당리 1473-2",
        "venue_zip": "63355",
        "venue_url": "https://naver.me/Fmf5fBh9",
        "venue_lat": 33.470073,
        "venue_lng": 126.783177,
        "photo_url": photo_url,
        "message_text": "서로의 계절을 지나\n웃음과 위로가 되어준 시간 끝에,\n저희는 같은 방향을 바라보며\n결혼이라는 이름의 시작점에 서게 되었습니다.\n\n앞으로의 날들 또한\n오늘처럼 서로의 편이 되겠다는 약속,\n그 순간을 소중한 분들과 함께 나누고 싶습니다.\n\n따뜻한 축복으로 함께해 주세요.",
        "message_footer": "사정 상 가까운 곳에서 예식을 치루지 못해\n양해 부탁드립니다.",
        "groom_account": "국민은행 122102-04-198755 한기정",
        "bride_account": "국민은행 480401-04-224672 방지윤",
        "groom_bank": "국민은행",
        "groom_holder": "한기정",
        "groom_number": "122102-04-198755",
        "groom_number_digits": "12210204198755",
        "bride_bank": "국민은행",
        "bride_holder": "방지윤",
        "bride_number": "480401-04-224672",
        "bride_number_digits": "48040104224672",
        "bride_father_bank": "ㅇㅇ은행",
        "bride_father_holder": "방창국",
        "bride_father_number": "111-111-1111",
        "bride_father_number_digits": "1111111111",
        "bride_mother_bank": "oo은행",
        "bride_mother_holder": "원숙",
        "bride_mother_number": "222-222-2222",
        "bride_mother_number_digits": "2222222222",
        "gallery_images": get_gallery_images(),
    }

    env = Environment(loader=FileSystemLoader(TEMPLATES_DIR), autoescape=True)
    template = env.get_template("index.html")
    html = template.render(**context)

    os.makedirs(OUT_DIR, exist_ok=True)
    index_path = os.path.join(OUT_DIR, "index.html")
    with open(index_path, "w", encoding="utf-8") as f:
        f.write(html)
    print("생성:", index_path)

    # static/ 복사
    out_static = os.path.join(OUT_DIR, "static")
    if os.path.isdir(out_static):
        shutil.rmtree(out_static)
    shutil.copytree(STATIC_DIR, out_static)
    print("복사: static/ -> docs/static/")

    # image/ 복사
    out_image = os.path.join(OUT_DIR, "image")
    if os.path.isdir(out_image):
        shutil.rmtree(out_image)
    shutil.copytree(IMAGE_DIR, out_image)
    print("복사: image/ -> docs/image/")

    print("\n빌드 완료. docs/ 폴더를 커밋 후 푸시하면 GitHub Pages에 반영됩니다.")
    print("저장소 설정 > Pages > Source: Deploy from a branch > Branch: main, /docs")


if __name__ == "__main__":
    build()
